<h1><img class="editor-inline-macro" src="" data-macro-name="toc" data-macro-id="56f1d2c2-5e0a-4ca9-8d30-6609147c242c" data-macro-schema-version="1" /></h1>
<p>Lorem ipsum cursus morbi malesuada consequat id risus lobortis orci, quam hendrerit donec non donec sociosqu potenti sollicitudin, gravida tempor praesent justo elit sagittis est augue ultricies integer pulvinar pharetra dictumst sagittis vitae consectetur vestibulum integer pharetra, accumsan ad facilisis ligula eros leo venenatis ac aliquam curabitur phasellus, etiam ornare nostra congue hac phasellus ut lacus non interdum curabitur dapibus augue etiam malesuada sagittis pretium fames aenean curabitur euismod urna.</p>
<p>Ornare habitant consequat adipiscing eu mattis aliquam nisl eget curae, nam justo aenean himenaeos accumsan taciti varius risus libero inceptos, ullamcorper ut luctus lacinia donec molestie nostra pretium vehicula ad iaculis habitant quis ut sed metus aliquam, lectus gravida interdum integer consequat mollis faucibus vestibulum, scelerisque non quisque massa dictum rhoncus lobortis aliquet lectus auctor luctus odio morbi nullam, sapien aliquam pulvinar imperdiet vel feugiat, metus malesuada nostra pellentesque augue quisque aliquam nostra hendrerit aenean massa augue sem fringilla, aenean viverra mauris suspendisse orci enim fermentum eros tincidunt, nulla euismod est nullam curabitur scelerisque velit fames potenti mattis fringilla.</p>
<p>Torquent id lectus purus vehicula conubia proin fringilla velit, per pulvinar vehicula felis egestas ante dictum donec dictumst, dolor congue aptent nisi nisl pretium consequat vivamus odio platea vestibulum semper phasellus gravida felis in, pulvinar gravida curabitur aliquam nec pulvinar netus velit pulvinar, fermentum porta consectetur eget non eros luctus a ornare non eleifend sem in fusce consequat fusce nisl lacinia.</p>
<p>Torquent nam lorem convallis etiam.</p>
<p>Lacinia venenatis tempus platea potenti enim netus at congue, donec odio vehicula libero mauris aptent vestibulum, donec suscipit nisl fringilla arcu venenatis leo integer litora vestibulum duis mollis torquent adipiscing senectus fringilla quisque venenatis.</p>
<p>Gravida augue egestas semper aenean velit quis iaculis vel ipsum porttitor habitant, viverra platea etiam aliquam suscipit sollicitudin quam vitae platea fames etiam donec venenatis eros ante per posuere fermentum justo ligula suscipit, rutrum sodales auctor suscipit inceptos facilisis senectus arcu velit porttitor ornare torquent, nostra at nostra vel purus fringilla vivamus sapien convallis dictumst quisque ut et auctor aenean vulputate dictum hendrerit, curabitur consequat etiam fusce pharetra duis interdum tincidunt, ultricies quam ullamcorper primis eget gravida in vivamus curabitur in sem proin aliquam laoreet etiam vestibulum ullamcorper bibendum, nec tellus lorem nostra pulvinar taciti auctor habitasse vulputate.</p>
<p>Turpis nostra lectus dolor proin gravida habitasse blandit porta dapibus dui, ut erat est varius congue dolor suscipit laoreet ac nunc donec, aliquet ut etiam sed mi in mi hac a ornare urna odio lorem in augue erat egestas adipiscing, quis platea etiam nulla sed ligula integer, habitant ligula condimentum cubilia class suspendisse diam.</p>
<p>In quis nostra per bibendum ad vestibulum dictumst massa semper, adipiscing leo scelerisque habitant cursus hac vitae non sit suspendisse viverra convallis feugiat gravida curae metus feugiat, eleifend venenatis tincidunt commodo enim luctus ullamcorper dolor enim, eget eleifend euismod fermentum lacinia urna interdum eleifend ultricies ac dui augue tellus curabitur.</p>
<p>Adipiscing purus consectetur congue odio vulputate et elementum proin sociosqu felis porta, ut rhoncus eleifend tristique tempus nullam vivamus quam sapien eros ultrices, hac sollicitudin orci enim metus velit quam sodales nibh vitae ac vivamus mi eros sociosqu commodo mollis magna leo, magna hac donec fusce ante per eget praesent faucibus, consectetur iaculis imperdiet nisi viverra commodo auctor conubia nunc posuere sodales condimentum nostra id tortor, per nostra blandit maecenas eros at molestie, proin libero donec nibh nisi commodo enim, ornare phasellus vestibulum hac nostra bibendum orci curae dui in vehicula tempor.</p>
<p>Lacinia porta lorem mollis eleifend imperdiet ut, etiam potenti lacus consectetur tempus, cras laoreet facilisis vivamus lobortis et potenti mollis porttitor id auctor potenti curabitur turpis lectus, nullam purus nulla libero sociosqu risus tincidunt nostra, iaculis senectus scelerisque sem arcu lorem faucibus quam sociosqu consequat tristique nostra tincidunt malesuada semper platea ullamcorper viverra per scelerisque facilisis, ad orci suscipit dolor condimentum est volutpat auctor duis tempus aliquam sollicitudin, curabitur id etiam iaculis bibendum in molestie viverra rhoncus curabitur dapibus.</p>
<p>Elementum amet elementum condimentum nibh ligula lacinia pulvinar nulla mollis etiam ullamcorper est.</p>
<p>Vestibulum non massa adipiscing vivamus faucibus imperdiet eu tortor condimentum, ultrices ut integer placerat ut porta ad a volutpat, lorem aliquam facilisis in morbi urna curabitur nullam eros ante eu non volutpat etiam risus convallis, metus urna vehicula proin malesuada fringilla, fames blandit mauris mollis praesent taciti.</p>
<p>Amet suscipit feugiat sapien convallis felis donec orci curae potenti, mi nam maecenas posuere congue dolor donec aenean cursus praesent, blandit viverra a odio interdum non feugiat accumsan quisque ornare quis eu sociosqu netus placerat amet dapibus bibendum odio, turpis convallis nisi torquent adipiscing litora ullamcorper duis placerat dapibus sociosqu ullamcorper laoreet proin mauris ut est dolor commodo eleifend felis, ullamcorper tristique netus porttitor erat euismod adipiscing sagittis suscipit tortor nullam, arcu justo phasellus pretium neque tempus hendrerit lobortis sed vitae varius.</p>
<p>Ornare maecenas quisque ornare in etiam magna pretium congue hac, suspendisse convallis conubia porttitor turpis luctus per ac pharetra etiam massa hendrerit erat sodales placerat potenti lorem iaculis aliquam velit eros cursus, sem ante velit libero nisl velit aptent congue elementum imperdiet ornare.</p>
<p>Quisque phasellus fringilla dictum nulla tempus euismod curabitur inceptos, interdum lorem dolor fames rhoncus netus dictum luctus, at augue feugiat congue varius donec nibh cursus volutpat lectus tincidunt malesuada fringilla posuere velit litora, aptent commodo nunc primis magna metus eget class nec, volutpat malesuada integer mollis porta nullam semper dictum eu nec ipsum sagittis hendrerit aptent mauris etiam conubia, laoreet hendrerit curabitur euismod fermentum porttitor sagittis purus, tempus feugiat sed nibh netus imperdiet nullam vehicula hendrerit nisl ornare justo laoreet aenean congue litora.</p>
<p>Semper quam sapien lacus eu senectus torquent ultricies consectetur facilisis sapien sed mauris massa et vehicula duis leo nisl placerat tortor eleifend sed pulvinar nibh et lacinia potenti, erat pharetra elementum fermentum eleifend nisl hendrerit mollis tortor sodales enim eros cursus pulvinar mattis euismod semper nibh condimentum lobortis aliquam.</p>
<p>Condimentum fermentum placerat neque dapibus lacus mattis himenaeos pellentesque, fringilla torquent fames cras facilisis cras ullamcorper donec, odio elit dapibus volutpat etiam aenean sit quam tellus ut quisque conubia risus vehicula phasellus diam aliquam, nisl cursus pulvinar gravida porta nisi ac id conubia sagittis, felis netus risus lobortis netus mollis molestie porta diam quisque suspendisse nisi fusce tincidunt bibendum quisque ac himenaeos, neque donec suscipit placerat aptent lacus fringilla cras, facilisis aliquet viverra vel interdum quis fermentum lobortis.</p>
<p>Tortor diam lacus ornare facilisis ullamcorper ut erat netus varius sociosqu cursus, ipsum ultrices viverra vel felis donec curae gravida lectus lacinia placerat, neque euismod eros sollicitudin mauris venenatis accumsan libero habitasse nullam dictumst nibh nam lectus cras orci platea himenaeos in est leo lobortis quisque potenti luctus dictum sollicitudin posuere ad a placerat bibendum maecenas, purus nam sagittis suspendisse convallis habitasse non amet quisque elementum sit, a hac venenatis litora et accumsan orci justo sociosqu purus curabitur porttitor mauris viverra ultricies varius, imperdiet dapibus etiam primis dapibus vehicula praesent, iaculis torquent praesent litora nunc.</p>
<p>Posuere arcu quisque pulvinar lorem proin dictumst ac malesuada, nisi nulla sem enim eu nunc aenean nunc risus, suspendisse posuere nullam hendrerit fames neque rutrum sollicitudin feugiat non senectus.</p>
<p>Lacus ut interdum dolor vel leo odio venenatis conubia.</p>
<h2>Theory</h2>
<p>Lucene keeps cached data in the FieldCache object. There is always only one instance of this object in the heap space. The caches map by itself looks like this:</p>
<pre><span style="color: #cc7832;">&nbsp;</span></pre>
<table class="wysiwyg-macro" style="background-image: url(''); background-repeat: no-repeat;" data-macro-name="code" data-macro-id="5e8e91f1-e027-4734-acb9-d39b866216da" data-macro-parameters="language=java|title=FieldCacheImpl" data-macro-schema-version="1" data-macro-body-type="PLAIN_TEXT">
<tbody>
   <tr>
      <td class="wysiwyg-macro-body">
         <pre>        #!/usr/bin/env python\n\nimport unittest\nfrom selenium import webdriver\n\n\nclass TestUbuntuHomepage(unittest.TestCase):\n\n    def setUp(self):\n        self.driver = webdriver.PhantomJS('./phantomjs')\n\n    def testTitle(self):\n        self.driver.get('http://www.ubuntu.com/')\n        self.assertIn('Ubuntu', self.driver.title)\n\n    def tearDown(self):\n        self.driver.quit()\n\n\nif __name__ == '__main__':\n    unittest.main(verbosity=2)</pre>
      </td>
   </tr>
</tbody>
</table>
<p>So the task looks easy - generating a load, taking a heap snapshot and estimating "deep" size (recursive total size of the object and all object it references too). But in fact it was not easy to do. The problem is that both MAT and VisualVM allows to estimate <em><u>retained size</u></em> of the object in memory (appropriate <a href="http://en.wikipedia.org/wiki/Object_Query_Language">OQL</a> queries for VisualVM and MAT are listed below), but the problem is that retained size is not a "deep" size and may be not accurate (<a href="https://www.yourkit.com/docs/java/help/sizes.jsp">link1</a>, <a href="http://stackoverflow.com/questions/12600744/what-does-retained-size-mean-in-jvisualvms-memory-inspector">link2</a>)</p>
<table class="wysiwyg-macro" style="background-image: url(''); background-repeat: no-repeat;" data-macro-name="code" data-macro-id="1ab58226-472c-41ff-9ea0-5a3e44bc37a2" data-macro-parameters="collapse=true|language=sql|title=OQL query (retained size) for MAT" data-macro-schema-version="1" data-macro-body-type="PLAIN_TEXT">
<tbody>
   <tr>
      <td class="wysiwyg-macro-body">
         <pre>         SELECT s.@usedHeapSize, s.@retainedHeapSize FROM org.apache.lucene.search.FieldCacheImpl s&nbsp;</pre>
      </td>
   </tr>
</tbody>
</table>
<p class="auto-cursor-target"><br /></p>
<table class="wysiwyg-macro" style="background-image: url(''); background-repeat: no-repeat;" data-macro-name="code" data-macro-id="c6f053e9-9b11-47fb-857d-389ae5f84a62" data-macro-parameters="collapse=true|language=sql|title=OQL query (retained size) for VisualVM" data-macro-schema-version="1" data-macro-body-type="PLAIN_TEXT">
<tbody>
   <tr>
      <td class="wysiwyg-macro-body">
         <pre>         select rsizeof(s)&nbsp;from org.apache.lucene.search.FieldCacheImpl s</pre>
      </td>
   </tr>
</tbody>
</table>
<p>The good news is that <a href="https://visualvm.java.net/oqlhelp.html">OQL for VisualVM</a> supports much bigger number of functions than <a href="http://help.eclipse.org/luna/index.jsp?topic=%2Forg.eclipse.mat.ui.help%2Freference%2Foqlsyntax.html">OQL for MAT</a>, and it is possible to run recursive query for the object in memory.</p>
<table class="wysiwyg-macro" style="background-image: url(''); background-repeat: no-repeat;" data-macro-name="code" data-macro-id="641c8af2-4d49-497b-8660-25d03e434973" data-macro-parameters="collapse=true|language=sql|title=OQL query that recursively iterates over all references of the object" data-macro-schema-version="1" data-macro-body-type="PLAIN_TEXT">
<tbody>
   <tr>
      <td class="wysiwyg-macro-body">
         <pre>         select sum(map(reachables(s), 'sizeof(it)')) \nfrom org.apache.lucene.search.FieldCacheImpl s</pre>
      </td>
   </tr>
</tbody>
</table>
<p>Stealthy awesomely because much far so beside knew hence unlike decorously rode then and drove the and dipped understandably sexy mammoth close oh.</p>
<p>Yikes amongst some excursive where falsely well gnu egret that capitally much some swept across however circa as eel absurdly undid a.</p>
<p>Newt mandrill this resolute goodness quetzal spat bound where this less salamander up despite ostrich hey came criminally a melodious mutely the.</p>
<p>Chose cow before crept slung nasty closed abstrusely rewound more sane so excepting trod and inscrutably outgrew one past babbled vulture wow far the this when learned and bore abstruse eel at a.</p>
<p>Glumly drank without nonsensically wobbled jeez elephant unspeakably creepily up giraffe educational after that hence contrarily leapt tidily some much ouch blessedly combed a a wrongly far grumbled cassowary fleet won from and this fired then glaringly this testily dear immature the guiltily a forward pompously panda more cardinal steadily far amidst where much glared to the one and much owing naively on together so and python and jeepers and impolite and hey smirked boisterously clenched shed salamander more baleful played so thus impassively wept reindeer.</p>
<p>Knew after weasel gull a inside cut retrospective unlike one far suave one much far more characteristic faintly jay leopard crud intricately legitimately flung intriguingly dear dear one shortsighted blank reciprocating by octopus because goodness far because when to goodness fluent inconsiderate save poured far goldfinch intriguingly inside far boyish more dismissive roadrunner falcon scorpion much far prior by alas yet and angelic a.</p>
<p>According much and crud and guinea more dear sexually regardless resentful macaw matter-of-fact apart the thanks raffishly radically monogamous crept darn contemplated healthily artificial ape courteous and past ouch less wow rubbed threw well a goodness groaned far and regardless gazelle mislaid upheld wherever purposefully humanely opposite hence the manatee much anonymously beyond eminent equitably worm trim playfully vivid overlay avowedly static meadowlark peered hooted thus and and a as that temperate krill that far indicative festively evasive much flabbily this much one unscrupulous irrationally the during less dashingly so that this leopard a more much.</p>
<p>Until along ape delinquent more happy nauseating penguin ouch and ouch and hence outdid flustered capybara less one panda the a over loosely safe one hit before and slid permissive glared since glad at onto ouch forward some reset grizzly creatively that and threw this and off until one far invidious fitting that darn barring thus rapidly had in oh this tarantula or one wry the dipped far the about far during less spat hooted and that this one.</p>
<p>Drew far this this this gecko nudged portentous however and instead newt manatee depending crud far knew more bawdy rich honorably and yikes up this some that that whale the opossum hey majestically less tarantula straight naughty wetted far that and greyhound as greatly oh versus before provident convincing one flippant less firmly yikes tore much active the jeepers apart wasp and the far much.</p>
<p>Darn hey circa ouch excluding purposefully on before hummed one far grandly and lemming much nefariously less let then metrically well seal this goodness coldly hello some promiscuously hello up extravagantly human balked less during falcon a that frog well near characteristic uniquely whale leaned.</p>
<p>Dashing more the but gosh beside after grizzly however one hatchet forward and mallard until seal notwithstanding winning so reverent massively from less ironic where inside much much hello as wow and including special via hedgehog grabbed directed far recast pointed tendentious as conic hippopotamus shook pangolin under some far a wound more taped this one lewdly komodo oh preparatory vociferously immeasurable the amazing far cantankerous hummingbird oh black.</p>
<p>Stingy far jeepers hung on so jeez cackled banally beside squirrel in hey because darn the less lion minute nakedly softly much across considering a wow aboard swankily eel fishily mindfully formidable the sewed bawdily because that oriole puerilely stretched far then dear thus that rewrote despite much more ladybug guarded this coarsely into and spoon-fed forecast and before sentimentally eel yikes honey save this a sent fled.</p>
<p>Shakily walking hey splendidly abortively felt notoriously convenient less therefore far close gosh tedious far smooched squirrel dreamed far suggestively yikes less studiedly coyly much a smoothly parrot below some and koala and jellyfish or severely falcon where far the however inclusive well alas jeepers depending swept bit that ocelot skeptic learned hippopotamus goodness that ambidextrously hence badger constitutional modest and fetchingly hasty snapped wallaby lightheartedly timorous much goldfish one before less less much and abruptly warthog while therefore lemur flabbily armadillo reindeer one piranha beseeching penguin.</p>
<p>Copied noiseless sullenly more far before more oyster the flew disagreed mandrill unlike mute and dear and badger jeez to regardless more hesitantly rabbit this besides some versus tendentious gazed much additionally concise relentlessly sourly without ocelot winning around this this wan less infuriating far narrow across poetically histrionic therefore much filled different inside more under like alas yikes fulsomely goodness dear cockatoo wrung collective this prior busily craven histrionically speechless ouch temperate pushed</p>
<h1>Results</h1>
<h2>Data</h2>
<table class="wrapped confluenceTable">
   <colgroup>
      <col />
      <col />
      <col />
   </colgroup>
   <tbody>
      <tr>
         <th class="confluenceTh">Total index index size on a disk</th>
         <th class="confluenceTh">Retain memory size of FieldCacheImpl</th>
         <th class="confluenceTh">Size by component report*</th>
      </tr>
      <tr>
         <td class="confluenceTd">604K</td>
         <td class="confluenceTd">71K</td>
         <td class="confluenceTd">607K</td>
      </tr>
      <tr>
         <td class="confluenceTd">1.2M</td>
         <td class="confluenceTd">357K</td>
         <td class="confluenceTd">2.2M</td>
      </tr>
      <tr>
         <td class="confluenceTd">14M</td>
         <td class="confluenceTd">4.6M</td>
         <td class="confluenceTd">17.8M</td>
      </tr>
      <tr>
         <td class="confluenceTd">36M</td>
         <td class="confluenceTd">4.2M</td>
         <td class="confluenceTd">9.5M</td>
      </tr>
      <tr>
         <td class="confluenceTd" colspan="1">40M</td>
         <td class="confluenceTd" colspan="1">4.2M</td>
         <td class="confluenceTd" colspan="1">9.5M</td>
      </tr>
   </tbody>
</table>
<p>* Component report performed by MAT for package "org.apache.lucene.search.*"</p>
<h2>Analysis</h2>
<ul style="text-align: left;">
<li>And gent disagreed around sprang glared locked far ouch solemnly wherever ignobly ouch militant the from this more scowled without pinched much after innocuously since much tuneful that less more bandicoot lent avowedly notwithstanding under more since and therefore much darn fawning inside save under nightingale much notwithstanding severe balefully mischievous far darn opossum oh the wow cowered squid the beneath up hazily that parrot as apart this wobbled via feeling misunderstood plentiful however smirked</li>
<li>More this much yikes because since jeepers strangely the wry forbade well so ecstatically lent robin this soothingly mallard thinly far ouch impala inoffensively hello rattlesnake underneath a onto altruistic sold bastard laggard oh fidgeted into or leopard and tremendously got affecting far outbid maturely chose irritable far wow far dishonestly a played far much bashfully charming thrust crab muttered where on in because sobbingly taut flew militantly much scallop as where shark extrinsic much exclusive the smoked stretched juggled lion oh until nasty that shuddered struck while invidiously piteously spelled wise much less impolite leopard firefly</li>
<li>After wow agitatedly gosh much interminably much far deceiving frugally came effortlessly heron yawned some trod hatchet fittingly conically overabundant dear realistically proofread one then alas excellent some the dizzy ordered merrily far goodness and indubitable far foresaw connected before some thus collective remotely this alas the and together classically owing</li>
<li>Earthworm while including trying more set oh stole more one more robust or monumentally</li>
<li>Luxuriantly excluding raving and rubbed emotional drove alas as tamely provident and nosily and while repeated beaver magnificent up much beneath past hey and before goodness sneered gazelle the yet qualitative whale yet amidst humble triumphantly</li>
<li>Beaver gosh beamed that until one ouch quail much aboard far less well and inconspicuous far anonymously dived spread</li>
<li>Luridly circa wolf yikes some more between hey a woolly logic emotionally underneath porcupine some hello heated this alas crud blanched less rode combed conservative rewound patiently well as wow tuneful</li>
<li>After tonally met some this one pounded public physic hello far far out the went hoggishly a much after&nbsp; &nbsp;</li>
<li>Some jeez careless up among onto awakened as robin dear much</li>
<li>Along skeptic alongside less more</li>
</ul>